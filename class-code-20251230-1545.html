<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI èª²ç¨‹æƒ…å¢ƒè¦åŠƒè¡¨ | å®å¤§è·è¨“ Ã— Force Cheng</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <!-- å¼•å…¥ PapaParse ç”¨æ–¼è§£æ CSV (CDN) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <style>
        :root {
            --google-blue: #1a73e8;
            --google-blue-dark: #1557b0;
            --google-red: #ea4335;
            --google-green: #34a853;
            --google-yellow: #fbbc04;
            --gray-50: #f8f9fa;
            --gray-100: #f1f3f4;
            --gray-200: #e8eaed;
            --gray-600: #5f6368;
            --gray-800: #202124;
            --shadow-card: 0 1px 2px 0 rgba(60,64,67,0.3), 0 1px 3px 1px rgba(60,64,67,0.15);
            --shadow-hover: 0 1px 3px 0 rgba(60,64,67,0.3), 0 4px 8px 3px rgba(60,64,67,0.15);
        }

        * { box-sizing: border-box; }
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: var(--gray-50);
            color: var(--gray-800);
            margin: 0;
            padding: 0;
            line-height: 1.5;
        }

        /* Header */
        header {
            background: white;
            padding: 1rem;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        .header-content {
            max-width: 1000px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        .title-area h1 {
            margin: 0;
            font-size: 1.25rem;
            color: var(--google-blue);
        }
        .title-area p {
            margin: 0.25rem 0 0;
            font-size: 0.875rem;
            color: var(--gray-600);
        }
        
        /* Links Area */
        .links-area {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 0.5rem;
        }

        /* Source Link Button Base */
        .source-link {
            display: inline-flex;
            align-items: center;
            text-decoration: none;
            font-size: 0.85rem;
            font-weight: 500;
            padding: 4px 12px;
            border-radius: 12px;
            transition: background 0.2s;
        }
        
        /* Specific Link Colors */
        .link-sheet {
            color: var(--google-green);
            background: #e6f4ea;
        }
        .link-sheet:hover {
            background: #ceead6;
        }

        .link-slide {
            color: var(--google-red);
            background: #fce8e6;
        }
        .link-slide:hover {
            background: #fad2cf;
        }

        /* Controls */
        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            align-items: center;
            justify-content: space-between;
            margin-top: 0.5rem;
        }
        .view-toggle {
            display: flex;
            background: var(--gray-100);
            border-radius: 20px;
            padding: 4px;
        }
        .view-btn {
            border: none;
            background: transparent;
            padding: 6px 16px;
            border-radius: 16px;
            font-size: 0.9rem;
            cursor: pointer;
            color: var(--gray-600);
            font-weight: 500;
            transition: all 0.2s;
        }
        .view-btn.active {
            background: white;
            color: var(--google-blue);
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }

        .filter-group {
            display: flex;
            gap: 0.5rem;
            overflow-x: auto;
            padding-bottom: 4px;
            -webkit-overflow-scrolling: touch;
        }
        .filter-select {
            padding: 6px 12px;
            border: 1px solid var(--gray-200);
            border-radius: 8px;
            font-size: 0.85rem;
            color: var(--gray-600);
            background: white;
        }

        /* Status Bar */
        .status-bar {
            font-size: 0.75rem;
            color: var(--gray-600);
            text-align: right;
            margin-top: -10px;
            margin-bottom: 10px;
            padding-right: 1rem;
        }
        .status-ok { color: var(--google-green); }
        .status-error { color: var(--google-red); }

        /* Main Content */
        main {
            max-width: 1000px;
            margin: 1rem auto;
            padding: 0 1rem;
        }
        .card-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1rem;
        }
        @media (min-width: 768px) {
            .card-grid { grid-template-columns: repeat(2, 1fr); }
        }

        /* Cards */
        .card {
            background: white;
            border-radius: 12px;
            padding: 1.25rem;
            box-shadow: var(--shadow-card);
            transition: box-shadow 0.2s;
            cursor: pointer;
            border-left: 4px solid transparent;
        }
        .card:hover {
            box-shadow: var(--shadow-hover);
        }
        .card.expanded {
            border-left-color: var(--google-blue);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 0.5rem;
        }
        .card-id {
            font-size: 0.75rem;
            color: var(--gray-600);
            background: var(--gray-100);
            padding: 2px 6px;
            border-radius: 4px;
            font-family: monospace;
            flex-shrink: 0;
            margin-left: 8px;
        }
        .card-title {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--gray-800);
            flex: 1;
        }
        .card-narrative {
            font-size: 0.95rem;
            color: var(--gray-600);
            margin-bottom: 1rem;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        .card.expanded .card-narrative {
            -webkit-line-clamp: unset;
            color: var(--gray-800);
        }

        /* Tags Area (Collapsed) */
        .card-preview-tags {
            display: flex;
            gap: 4px;
            flex-wrap: wrap;
        }
        .mini-tag {
            font-size: 0.7rem;
            padding: 2px 6px;
            border-radius: 4px;
            background: var(--gray-100);
            color: var(--gray-600);
        }
        .mini-tag.S { background: #e8f0fe; color: #1967d2; }
        .mini-tag.B { background: #e6f4ea; color: #137333; }
        .mini-tag.M { background: #fce8e6; color: #c5221f; }
        .mini-tag.Other { background: #f1f3f4; color: #5f6368; }

        /* Expanded Details */
        .card-details {
            display: none;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid var(--gray-100);
            animation: fadeIn 0.3s ease;
        }
        .card.expanded .card-details {
            display: block;
        }
        .card.expanded .card-preview-tags {
            display: none;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-5px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .detail-section {
            margin-bottom: 1rem;
        }
        .detail-title {
            font-size: 0.8rem;
            font-weight: 700;
            color: var(--gray-600);
            margin-bottom: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        /* List for detailed codes */
        .code-list {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        .code-item {
            display: flex;
            font-size: 0.9rem;
            align-items: flex-start; /* Changed to start for wrapping text */
        }
        .code-badge {
            font-family: monospace;
            font-size: 0.8rem;
            font-weight: 700;
            padding: 2px 6px;
            border-radius: 4px;
            margin-right: 8px;
            min-width: 50px;
            text-align: center;
            flex-shrink: 0;
            margin-top: 2px; /* Align with text */
        }
        .code-desc {
            color: var(--gray-800);
            word-break: break-word;
        }
        
        /* Specific Code Colors */
        .badge-B { background: #e6f4ea; color: #137333; }
        .badge-M { background: #fce8e6; color: #c5221f; }
        .badge-T { background: #feefe3; color: #b06000; }
        .badge-S { background: #e8f0fe; color: #1967d2; }
        .badge-iPAS { background: #f1f3f4; color: #5f6368; border: 1px solid #dadce0; }
        .badge-Other { background: #eee; color: #777; }

        /* Footer */
        footer {
            margin-top: 3rem;
            padding: 2rem 1rem;
            background: white;
            border-top: 1px solid var(--gray-200);
            text-align: center;
            font-size: 0.8rem;
            color: var(--gray-600);
        }

        /* Forward View Styling */
        .section-header {
            grid-column: 1 / -1;
            margin-top: 1.5rem;
            margin-bottom: 0.5rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid var(--gray-200);
            color: var(--google-blue-dark);
        }
        .reverse-ref {
            font-size: 0.85rem;
            background: var(--gray-100);
            padding: 4px 8px;
            border-radius: 4px;
            margin-bottom: 4px;
            display: inline-block;
            margin-right: 4px;
        }
        
        #loading-indicator {
            text-align: center;
            padding: 2rem;
            color: var(--gray-600);
            font-style: italic;
        }
    </style>
</head>
<body>

<header>
    <div class="header-content">
        <div class="title-area">
            <h1>AI èª²ç¨‹æƒ…å¢ƒèˆ‡å…§å®¹å°ç…§è¡¨</h1>
            <p>å®å¤§è·è¨“ä¸­å¿ƒ Ã— Force Cheng | è¨è«–åº•ç¨¿ v1.4</p>
            <div class="links-area">
                <a href="https://docs.google.com/spreadsheets/d/1VeS9eBSvBZjkSZmjAOm0ujI8csxy57FFSoWtBxMhsIY/edit?usp=sharing" target="_blank" class="source-link link-sheet">
                    ğŸ“Š æŸ¥çœ‹ Google Sheet
                </a>
                <a href="https://drive.google.com/file/d/1NPPl5RLz6YA-JcYJ-dDprnfUEQME2efm/view?usp=sharing" target="_blank" class="source-link link-slide">
                    ğŸ“‘ æŸ¥çœ‹ç°¡å ±æª”
                </a>
            </div>
        </div>
        <div class="controls">
            <div class="view-toggle">
                <button class="view-btn active" onclick="switchView('reverse')" id="btn-reverse">æƒ…å¢ƒå°å‘ (é€†å‘)</button>
                <button class="view-btn" onclick="switchView('forward')" id="btn-forward">èª²ç¨‹å…§å®¹ (é †å‘)</button>
            </div>
            <div class="filter-group" id="filter-container">
                <!-- Filters will be injected here -->
            </div>
        </div>
    </div>
</header>
<div class="header-content">
    <div id="data-status" class="status-bar">æ­£åœ¨è®€å– Google Sheet...</div>
</div>

<main id="main-content">
    <div id="loading-indicator">
        æ­£åœ¨é€£ç·šè‡³ Google Sheet å–å¾—æœ€æ–°è³‡æ–™...<br>
        <small>è‹¥è®€å–éä¹…ï¼Œå°‡è‡ªå‹•åˆ‡æ›ç‚ºå…§å»ºå‚™ä»½è³‡æ–™ã€‚</small>
    </div>
</main>

<footer>
    <p>Â© 2025/12/30 Force Cheng åŸåŠ›ç‹ è€å¸«</p>
    <p>æœ¬é ç‚º AI èª²ç¨‹èˆ‡é«”é©—èª²è¦åŠƒä¹‹å…§éƒ¨è¨è«–ç”¨è³‡æ–™åº•ç¨¿ã€‚</p>
    <p>æœªç¶“åŒæ„ä¸å¾—å°å¤–å•†ç”¨ã€è½‰å”®æˆ–é‡æ–°æ•£ä½ˆã€‚</p>
    <p>å¼•ç”¨æˆ–æ”¹ä½œè«‹æ¨™è¨»ä¾†æºï¼šForce Cheng Ã— å®å¤§è·è¨“ä¸­å¿ƒ</p>
</footer>

<script>
    // ==========================================
    // 1. SETTINGS & FALLBACK DATA
    // ==========================================
    
    // Google Sheet Config
    const SHEET_ID = '1VeS9eBSvBZjkSZmjAOm0ujI8csxy57FFSoWtBxMhsIY';
    
    // å‚™ç”¨è³‡æ–™ (Fallback Data) 
    const FALLBACK_DATA = {
        b_dict: {
            "B001": { title: "å°ˆæ¥­æˆ–è¤‡é›œå…§å®¹è½‰ç™½è©±", desc: "å°‡å°ˆæ¥­åè©...è½‰æ›ç‚ºä¸€èˆ¬äººå¯ä»¥ç†è§£çš„èªè¨€" },
            "B002": { title: "é—œéµè³‡è¨Šèˆ‡é‡é»æŠ“å–", desc: "æŠ“å‡ºé—œéµæ¢ä»¶ã€æ•¸å­—ã€æœŸé™èˆ‡é‡é»" }
        },
        m_dict: {
            "M001": { title: "é«˜é¢¨éšªé—œéµå­—èˆ‡ç¦å¿Œè¾¨è­˜", desc: "è¾¨è­˜æ–‡ä»¶...ä»£è¡¨é«˜é¢¨éšªã€ç¦å¿Œçš„é—œéµå­—" },
            "M002": { title: "å°ˆæ¥­è½‰äº¤èˆ‡åœæé‚Šç•Œåˆ¤æ–·", desc: "åˆ¤æ–·å“ªäº›æƒ…æ³å¿…é ˆåœæ­¢è™•ç†" }
        },
        t_dict: {
            "T001": "Google Gemini", "T007": "Google Lens"
        },
        s_dict: {
            "S01": "é†«ç™‚èˆ‡å¥åº·ç†è§£"
        },
        contexts: [
            {
                id: "C01",
                title: "çœ‹ä¸æ‡‚çš„è—¥è¢‹ã€è—¥å–® (å‚™ä»½è³‡æ–™)",
                narrative: "é€™æ˜¯å‚™ä»½è³‡æ–™ã€‚æ—¥å¸¸ç”Ÿæ´»æ”¶åˆ°è—¥è¢‹ï¼Œéœ€ç†è§£åŠ‘é‡ã€æ™‚æ©Ÿèˆ‡ç¦å¿Œã€‚",
                b_codes: [
                    {code:"B001", type:"B", text:"å°ˆæ¥­å…§å®¹è½‰ç™½è©±"},
                    {code:"B002", type:"B", text:"æŠ“å‡ºé—œéµé‡é»"}
                ],
                m_codes: [
                    {code:"M001", type:"M", text:"é«˜é¢¨éšªé—œéµå­—è¾¨è­˜"}, 
                    {code:"M002", type:"M", text:"è½‰äº¤å°ˆæ¥­é‚Šç•Œ"}
                ],
                t_codes: [
                    {code:"T007", type:"T", text:"Google Lens (æ‹ç…§)"},
                    {code:"T001", type:"T", text:"Google Gemini"}
                ],
                s_codes: [
                    {code:"S01", type:"S", text:"é†«ç™‚èˆ‡å¥åº·ç†è§£"}
                ],
                ipas: [
                    {code:"L11101", type:"iPAS", text:"L11101"}
                ]
            }
        ]
    };

    // Global Data Containers
    let b_dict = {};
    let m_dict = {};
    let t_dict = {};
    let s_dict = {};
    let contexts = [];

    // ==========================================
    // 2. DATA LOADING LOGIC (ETL)
    // ==========================================

    async function fetchAllData() {
        const statusEl = document.getElementById('data-status');
        
        try {
            const fetchSheet = (sheetName) => {
                const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(sheetName)}`;
                return fetch(url).then(r => {
                    if(!r.ok) throw new Error(`Sheet ${sheetName} not found`);
                    return r.text();
                });
            };

            const results = await Promise.allSettled([
                fetchSheet('30æƒ…å¢ƒ'),      
                fetchSheet('Båˆ†é¡-åŸºæœ¬èª²ç¨‹'),   
                fetchSheet('ï¼­åˆ†é¡-é€²éšèª²ç¨‹'),   
                fetchSheet('ï¼´åˆ†é¡-å·¥å…·'),     
                fetchSheet('Såˆ†é¡-æƒ…å¢ƒ')       
            ]);

            const [resC, resB, resM, resT, resS] = results;

            // Process Dictionaries
            if (resB.status === 'fulfilled') processBDict(resB.value);
            else b_dict = FALLBACK_DATA.b_dict;

            if (resM.status === 'fulfilled') processMDict(resM.value);
            else m_dict = FALLBACK_DATA.m_dict;

            if (resT.status === 'fulfilled') processTDict(resT.value);
            else t_dict = FALLBACK_DATA.t_dict;

            if (resS.status === 'fulfilled') processSDict(resS.value);
            else s_dict = FALLBACK_DATA.s_dict;

            // Process Contexts
            if (resC.status === 'fulfilled') {
                processContexts(resC.value);
                statusEl.innerHTML = '<span class="status-ok">â— å·²é€£ç·šè‡³ Google Sheet (å³æ™‚è³‡æ–™)</span>';
            } else {
                console.warn("Failed Context fetch, using fallback");
                contexts = FALLBACK_DATA.contexts;
                statusEl.innerHTML = '<span class="status-error">â— ç„¡æ³•è®€å– Sheet (ä½¿ç”¨å‚™ä»½è³‡æ–™) - è«‹ç¢ºèªåˆ†é åç¨±</span>';
            }

            initApp();

        } catch (e) {
            console.error("Critical Fetch Error", e);
            useFallback();
        }
    }

    function useFallback() {
        b_dict = FALLBACK_DATA.b_dict;
        m_dict = FALLBACK_DATA.m_dict;
        t_dict = FALLBACK_DATA.t_dict;
        s_dict = FALLBACK_DATA.s_dict;
        contexts = FALLBACK_DATA.contexts;
        document.getElementById('data-status').innerHTML = '<span class="status-error">â— ä½¿ç”¨å…§å»ºå‚™ä»½è³‡æ–™ (é›¢ç·šæ¨¡å¼)</span>';
        initApp();
    }

    // --- New Parser: æ™ºæ…§æå–æ¨™é¡Œæ¨¡å¼ ---
    function parseRawCodes(str) {
        if (!str) return [];
        
        // 1. åˆ‡åˆ†
        const parts = str.split(/[;ï¼›\n,ï¼Œã€]+/);
        
        return parts.map(part => {
            part = part.trim();
            if (!part) return null;
            
            // 2. æ™ºæ…§æå–ï¼šæŠŠ "B001 æ¨™é¡Œ" åˆ†é›¢æˆ Code: B001, Text: æ¨™é¡Œ
            // Pattern: æŠ“é–‹é ­çš„ ä»£è™Ÿ (B001) + å¾Œé¢å‰©ä¸‹çš„æ‰€æœ‰æ–‡å­—
            const match = part.match(/^([BMTLS]\d{2,5})(.*)/i);
            
            let code = null;
            let type = 'Other';
            let cleanText = part; // é è¨­å…¨éƒ¨éƒ½æ˜¯æ–‡å­—

            if (match) {
                code = match[1].toUpperCase(); // e.g., B001
                const prefix = match[1].charAt(0).toUpperCase();
                
                // è¨­å®šé¡å‹
                if (prefix === 'B') type = 'B';
                if (prefix === 'M') type = 'M';
                if (prefix === 'T') type = 'T';
                if (prefix === 'S') type = 'S';
                if (prefix === 'L') type = 'iPAS';

                // æ¸…ç†å‰©ä¸‹çš„æ–‡å­—ï¼šç§»é™¤é–‹é ­çš„ ç©ºæ ¼ã€å†’è™Ÿã€é»ã€Dash
                let remaining = match[2].trim();
                remaining = remaining.replace(/^[:\.\-\s]+/, '');
                
                // åªæœ‰ç•¶å‰©ä¸‹çš„æ–‡å­—ä¸æ˜¯ç©ºç™½æ™‚ï¼Œæ‰æŠŠå®ƒç•¶ä½œ Text
                // å¦å‰‡å¦‚æœæ˜¯ "B001" (remainingæ˜¯ç©º)ï¼Œå°±è®“æ¸²æŸ“å±¤å»æŸ¥å­—å…¸
                if (remaining.length > 0) {
                    cleanText = remaining;
                } else {
                    cleanText = ""; // æ¨™è¨˜ç‚ºç©ºï¼Œç­‰å¾…æŸ¥å­—å…¸
                }
            } else {
                // æ²’æœ‰ä»£è™Ÿçš„æƒ…æ³ (ç´”æ–‡å­—)
            }

            return {
                code: code,
                type: type,
                text: cleanText, // é€™æ˜¯å»æ‰ä»£è™Ÿå¾Œçš„ã€Œä¹¾æ·¨æ¨™é¡Œã€
                raw: part       // ä¿ç•™åŸå§‹å®Œæ•´å­—ä¸²ä»¥å‚™ä¸æ™‚ä¹‹éœ€
            };
        }).filter(item => item !== null);
    }

    function parseWithDefaultType(str, defaultType) {
        const items = parseRawCodes(str);
        items.forEach(item => {
            if (item.type === 'Other') item.type = defaultType;
        });
        return items;
    }

    function processBDict(csvText) {
        Papa.parse(csvText, {
            header: true, skipEmptyLines: true,
            complete: function(results) {
                results.data.forEach(row => {
                    const code = row['B-code'] || row['ä»£ç¢¼'];
                    if (code && code.toUpperCase().startsWith('B')) {
                        b_dict[code.toUpperCase()] = {
                            title: row['åŸºç¤ç‰ˆå…§å®¹æ¨™é¡Œ'] || row['æ¨™é¡Œ'] || 'Unknown',
                            desc: row['åŸºç¤ç‰ˆå…§å®¹æè¿°ï¼ˆè¨è«–ç”¨ï¼‰'] || row['æè¿°'] || ''
                        };
                    }
                });
            }
        });
    }

    function processMDict(csvText) {
        Papa.parse(csvText, {
            header: true, skipEmptyLines: true,
            complete: function(results) {
                results.data.forEach(row => {
                    const code = row['M-code'];
                    if (code && code.toUpperCase().startsWith('M')) {
                        m_dict[code.toUpperCase()] = {
                            title: row['é€²éšç‰ˆå…§å®¹æ¨™é¡Œ'] || 'Unknown',
                            desc: row['é€²éšç‰ˆå…§å®¹æè¿°ï¼ˆè¨è«–ç”¨ï¼‰'] || ''
                        };
                    }
                });
            }
        });
    }

    function processTDict(csvText) {
        Papa.parse(csvText, {
            header: true, skipEmptyLines: true,
            complete: function(results) {
                results.data.forEach(row => {
                    const code = row['å·¥å…·ä»£ç¢¼'];
                    if (code && code.toUpperCase().startsWith('T')) {
                        t_dict[code.toUpperCase()] = row['å·¥å…·åç¨±'] + (row['å·¥å…·å®šä½èªªæ˜ï¼ˆåŠŸèƒ½æ‘˜è¦ï¼‰'] ? ` (${row['å·¥å…·å®šä½èªªæ˜ï¼ˆåŠŸèƒ½æ‘˜è¦ï¼‰']})` : '');
                    }
                });
            }
        });
    }

    function processSDict(csvText) {
        Papa.parse(csvText, {
            header: true, skipEmptyLines: true,
            complete: function(results) {
                results.data.forEach(row => {
                    const code = row['S-code'];
                    if (code && code.toUpperCase().startsWith('S')) {
                        s_dict[code.toUpperCase()] = row['æƒ…å¢ƒåˆ†é¡æ¨™é¡Œ'];
                    }
                });
            }
        });
    }

    function processContexts(csvText) {
        Papa.parse(csvText, {
            header: true, skipEmptyLines: true,
            complete: function(results) {
                contexts = results.data.map((row, index) => {
                    const title = row['A_å¸¸è¦‹æƒ…å¢ƒ'] || row['æƒ…å¢ƒåç¨±'];
                    if (!title) return null;

                    return {
                        id: `C${String(index + 1).padStart(2, '0')}`,
                        title: title,
                        narrative: row['B_æƒ…å¢ƒèªªæ˜ï¼ˆå®Œå–„ç‰ˆï¼‰'] || row['æƒ…å¢ƒèªªæ˜'] || '',
                        b_codes: parseWithDefaultType(row['C_åŸºç¤ç‰ˆèª²ç¨‹æœƒè¬›çš„å…§å®¹'], 'B'),
                        m_codes: parseWithDefaultType(row['D_é€²éšç‰ˆèª²ç¨‹æœƒè¬›çš„å…§å®¹'], 'M'),
                        t_codes: parseWithDefaultType(row['E_å·¥å…·ç”Ÿæ…‹ï¼ˆGoogleä¸» / OpenAIè¼” / å…¶ä»–é¾é ­ï¼‰'], 'T'),
                        s_codes: parseWithDefaultType(row['G_å°æ‡‰æƒ…å¢ƒ'], 'S'),
                        ipas: parseWithDefaultType(row['F_iPASè€ƒç§‘ï¼ˆå¯å¤šé¸ï¼‰'], 'iPAS')
                    };
                }).filter(item => item !== null);
            }
        });
    }

    // ==========================================
    // 3. LOGIC CENTER
    // ==========================================

    let currentView = 'reverse';
    let currentFilter = { type: 'all', value: '' };

    function initApp() {
        renderFilters();
        renderMain();
    }

    function switchView(viewName) {
        currentView = viewName;
        document.getElementById('btn-reverse').classList.toggle('active', viewName === 'reverse');
        document.getElementById('btn-forward').classList.toggle('active', viewName === 'forward');
        renderMain();
    }

    function setFilter(type, value) {
        currentFilter = { type, value };
        renderMain();
    }

    // --- Rendering Helpers ---

    function getTagHTML(item) {
        // item = { code: 'B001' or null, type: 'B', text: 'æ¨™é¡Œ' or '', raw: ... }
        let badgeClass = 'badge-Other';
        if (item.type === 'B') badgeClass = 'badge-B';
        else if (item.type === 'M') badgeClass = 'badge-M';
        else if (item.type === 'T') badgeClass = 'badge-T';
        else if (item.type === 'S') badgeClass = 'badge-S';
        else if (item.type === 'iPAS') badgeClass = 'badge-iPAS';

        const badgeText = item.code || 'â€¢';
        
        let displayText = item.text;
        
        if (!displayText && item.code) {
            if (item.type === 'B' && b_dict[item.code]) displayText = b_dict[item.code].title;
            else if (item.type === 'M' && m_dict[item.code]) displayText = m_dict[item.code].title;
            else if (item.type === 'T' && t_dict[item.code]) displayText = t_dict[item.code];
            else if (item.type === 'S' && s_dict[item.code]) displayText = s_dict[item.code];
            else displayText = ""; 
        }
        
        if (!displayText) displayText = item.raw || "";

        return `
            <div class="code-item">
                <span class="code-badge ${badgeClass}">${badgeText}</span>
                <span class="code-desc">${displayText}</span>
            </div>
        `;
    }

    function renderMain() {
        const container = document.getElementById('main-content');
        container.innerHTML = '';

        if (contexts.length === 0) {
            container.innerHTML = '<div style="text-align:center; padding:2rem;">è¼‰å…¥ä¸­æˆ–ç„¡è³‡æ–™...</div>';
            return;
        }

        if (currentView === 'reverse') {
            renderReverseView(container);
        } else {
            renderForwardView(container);
        }
    }

    // 1ï¸âƒ£ é€†å‘è¦–åœ–
    function renderReverseView(container) {
        const grid = document.createElement('div');
        grid.className = 'card-grid';

        let displayContexts = contexts;
        if (currentFilter.type !== 'all') {
            displayContexts = contexts.filter(ctx => {
                const key = currentFilter.type + '_codes';
                return ctx[key] && ctx[key].some(item => item.code === currentFilter.value);
            });
        }

        displayContexts.forEach(ctx => {
            const card = document.createElement('div');
            card.className = 'card';
            card.onclick = () => card.classList.toggle('expanded');

            const b_list = ctx.b_codes.map(item => getTagHTML(item)).join('');
            const m_list = ctx.m_codes.map(item => getTagHTML(item)).join('');
            const t_list = ctx.t_codes.map(item => getTagHTML(item)).join('');
            const s_list = ctx.s_codes.map(item => getTagHTML(item)).join('');
            const i_list = ctx.ipas.map(item => getTagHTML(item)).join('');

            // Preview tags
            const makeMiniTag = (item) => {
                let label = item.code;
                if (!label && item.text) label = item.text.substring(0, 5) + '..';
                if (!label) label = '?';
                return `<span class="mini-tag ${item.type}">${label}</span>`;
            };

            const previewTags = [
                ...ctx.s_codes.map(makeMiniTag),
                ...ctx.b_codes.map(makeMiniTag),
                ...ctx.m_codes.map(makeMiniTag)
            ].join('');

            card.innerHTML = `
                <div class="card-header">
                    <div class="card-title">${ctx.title}</div>
                    <div class="card-id">${ctx.id}</div>
                </div>
                <div class="card-narrative">${ctx.narrative}</div>
                <div class="card-preview-tags">${previewTags}</div>
                <div class="card-details">
                    ${ctx.s_codes.length ? `<div class="detail-section"><div class="detail-title">æƒ…å¢ƒåˆ†é¡ (S)</div><div class="code-list">${s_list}</div></div>` : ''}
                    ${ctx.b_codes.length ? `<div class="detail-section"><div class="detail-title">åŸºç¤èª²ç¨‹é» (B)</div><div class="code-list">${b_list}</div></div>` : ''}
                    ${ctx.m_codes.length ? `<div class="detail-section"><div class="detail-title">é€²éšèª²ç¨‹é» (M)</div><div class="code-list">${m_list}</div></div>` : ''}
                    ${ctx.t_codes.length ? `<div class="detail-section"><div class="detail-title">ä½¿ç”¨å·¥å…· (T)</div><div class="code-list">${t_list}</div></div>` : ''}
                    ${ctx.ipas.length ? `<div class="detail-section"><div class="detail-title">iPAS è€ƒé»</div><div class="code-list">${i_list}</div></div>` : ''}
                </div>
            `;
            grid.appendChild(card);
        });

        if (displayContexts.length === 0) {
            container.innerHTML = '<div style="text-align:center; padding:2rem; color:var(--gray-600)">æ²’æœ‰ç¬¦åˆç¯©é¸æ¢ä»¶çš„æƒ…å¢ƒ</div>';
        } else {
            container.appendChild(grid);
        }
    }

    // 2ï¸âƒ£ é †å‘è¦–åœ–
    function renderForwardView(container) {
        let usedB = new Set();
        let usedM = new Set();
        
        contexts.forEach(ctx => {
            ctx.b_codes.forEach(item => { if(item.code) usedB.add(item.code); });
            ctx.m_codes.forEach(item => { if(item.code) usedM.add(item.code); });
        });

        const renderCodeBlock = (codeType, codeSet, dict) => {
            const sectionTitle = document.createElement('h2');
            sectionTitle.className = 'section-header';
            sectionTitle.innerText = codeType === 'B' ? 'åŸºç¤èª²ç¨‹é» (B-Codes)' : 'é€²éšèª²ç¨‹é» (M-Codes)';
            container.appendChild(sectionTitle);

            const grid = document.createElement('div');
            grid.className = 'card-grid';

            Array.from(codeSet).sort().forEach(code => {
                const relatedContexts = contexts.filter(ctx => {
                   const list = codeType === 'B' ? ctx.b_codes : ctx.m_codes;
                   return list.some(item => item.code === code);
                });
                
                if (relatedContexts.length === 0) return;

                const card = document.createElement('div');
                card.className = 'card';
                card.onclick = () => card.classList.toggle('expanded');

                const info = dict[code] || { title: 'æ­¤ä»£è™Ÿæœªå®šç¾©è©³ç´°èªªæ˜', desc: '' };
                const relatedHTML = relatedContexts.map(ctx => 
                    `<div class="reverse-ref">${ctx.id} ${ctx.title}</div>`
                ).join('');

                card.innerHTML = `
                     <div class="card-header">
                        <div class="card-title"><span class="code-badge badge-${codeType}">${code}</span> ${info.title}</div>
                    </div>
                    <div class="card-narrative">${info.desc}</div>
                    <div class="card-details" style="display:block; margin-top:0.5rem; padding-top:0.5rem; border-top:1px dashed var(--gray-200)">
                        <div class="detail-title">æ‡‰ç”¨æ­¤æ¦‚å¿µçš„æƒ…å¢ƒï¼š</div>
                        <div>${relatedHTML}</div>
                    </div>
                `;
                grid.appendChild(card);
            });
            container.appendChild(grid);
        };

        renderCodeBlock('B', usedB, b_dict);
        renderCodeBlock('M', usedM, m_dict);
    }

    function renderFilters() {
        const container = document.getElementById('filter-container');
        container.innerHTML = ''; 
        
        const resetBtn = document.createElement('button');
        resetBtn.className = 'filter-select';
        resetBtn.innerText = 'å…¨éƒ¨é¡¯ç¤º';
        resetBtn.style.fontWeight = 'bold';
        resetBtn.onclick = () => setFilter('all', '');
        container.appendChild(resetBtn);

        const createSelect = (label, type, dict, codesInUse) => {
            const select = document.createElement('select');
            select.className = 'filter-select';
            select.onchange = (e) => setFilter(type, e.target.value);
            
            const defaultOpt = document.createElement('option');
            defaultOpt.text = `ä¾ ${label} ç¯©é¸...`;
            defaultOpt.value = "";
            select.appendChild(defaultOpt);

            codesInUse.sort().forEach(code => {
                const opt = document.createElement('option');
                opt.value = code;
                let name = "";
                if(type === 's') name = dict[code] || code;
                if(type === 'b' || type === 'm') name = dict[code]?.title || code;
                if(name.length > 15) name = name.substring(0,15) + "...";
                opt.text = `${code} ${name}`;
                select.appendChild(opt);
            });
            container.appendChild(select);
        };

        let uS = new Set(), uB = new Set(), uM = new Set();
        contexts.forEach(ctx => {
            ctx.s_codes.forEach(item => { if(item.code) uS.add(item.code); });
            ctx.b_codes.forEach(item => { if(item.code) uB.add(item.code); });
            ctx.m_codes.forEach(item => { if(item.code) uM.add(item.code); });
        });

        createSelect('æƒ…å¢ƒ (S)', 's', s_dict, Array.from(uS));
        createSelect('åŸºç¤ (B)', 'b', b_dict, Array.from(uB));
        createSelect('é€²éš (M)', 'm', m_dict, Array.from(uM));
    }

    // Start
    fetchAllData();

</script>

</body>
</html>